import os
import os.path
import time
from PIL import Image

import h5py
import numpy

TARGETS = {'n07751451': 776, 'n03558404': 464, 'n04613696': 721, 'n13032115': 988, 'n01807496': 62, 'n02916936': 298, 'n03794056': 527, 'n11608250': 815, 'n01786646': 54, 'n03126707': 358, 'n03394916': 417, 'n03710193': 498, 'n02326432': 183, 'n02782093': 243, 'n04044716': 585, 'n07753275': 778, 'n02802426': 256, 'n04136333': 607, 'n02112826': 118, 'n12272883': 919,
'n03020692': 335, 'n04131690': 605, 'n03535780': 458, 'n12075151': 897, 'n03534580': 457, 'n02676566': 226, 'n09468604': 813, 'n12727101': 960, 'n12513613': 943, 'n07723177': 747, 'n03649909': 484, 'n12059314': 885, 'n11807979': 836, 'n11839568': 840, 'n03443371': 425, 'n02256656': 166, 'n01677366': 19, 'n04482393': 685, 'n03062245': 343, 'n09399592': 810, 'n03127925': 360,
'n02264363': 169, 'n02087394': 92, 'n07718472': 738, 'n07726095': 750, 'n03014440': 330, 'n01968897': 78, 'n07725531': 749, 'n03724870': 504, 'n07720277': 741, 'n02169497': 155, 'n02536864': 217, 'n01728920': 30, 'n09193705': 803, 'n12523475': 945, 'n02483362': 195, 'n02128757': 140, 'n12058630': 884, 'n01484850': 0, 'n04154565': 617, 'n03447447': 429, 'n01770393': 44, 'n09256479': 805,
'n07720875': 742, 'n03930313': 560, 'n03196217': 371, 'n02871525': 282, 'n03290653': 391, 'n07771212': 794, 'n03483316': 442, 'n07714571': 730, 'n06785654': 725, 'n04033901': 581, 'n12072722': 892, 'n07772274': 796, 'n12261808': 915, 'n01796340': 57, 'n12047345': 875, 'n07742313': 764, 'n04118021': 599, 'n02835271': 272, 'n12492106': 939, 'n07749582': 774, 'n02283201': 178, 'n01496331': 3,
'n02997607': 326, 'n03272010': 388, 'n01770081': 43, 'n03388043': 413, 'n07929351': 802, 'n03188531': 370, 'n02837789': 273, 'n01924916': 67, 'n03459775': 434, 'n04487394': 689, 'n04090263': 594, 'n12755727': 967, 'n03710637': 499, 'n03950228': 563, 'n07714990': 731, 'n02117135': 127, 'n07770763': 793, 'n02109047': 111, 'n03089624': 351, 'n11793779': 834, 'n12726670': 959, 'n02870880': 281,
'n06267145': 722, 'n01739381': 36, 'n02480855': 193, 'n01773157': 45, 'n03207941': 374, 'n02667093': 223, 'n03271574': 387, 'n01740131': 37, 'n02233338': 164, 'n02687172': 228, 'n11906917': 851, 'n12407222': 937, 'n03017168': 332, 'n01943899': 70, 'n03388183': 414, 'n04074963': 591, 'n01797886': 58, 'n02799071': 255, 'n07744811': 768, 'n03484931': 444, 'n07722485': 745, 'n03216828': 375,
'n12043673': 872, 'n07732747': 755, 'n11733054': 826, 'n03777568': 517, 'n02879718': 285, 'n11901977': 848, 'n11703669': 819, 'n04591157': 719, 'n02486261': 198, 'n02883205': 287, 'n03637318': 482, 'n01694178': 27, 'n03179701': 367, 'n13060190': 996, 'n02328150': 184, 'n03344393': 401, 'n03379051': 411, 'n03529860': 455, 'n03538406': 459, 'n04590129': 718, 'n02666196': 222, 'n04033995': 582,
'n02795169': 253, 'n02504458': 212, 'n04239436': 636, 'n03888605': 550, 'n03729826': 505, 'n04462240': 681, 'n04205318': 627, 'n11943992': 858, 'n03042490': 341, 'n02980441': 321, 'n03627232': 478, 'n03978966': 572, 'n02892767': 290, 'n12093329': 904, 'n04209133': 629, 'n12544539': 947, 'n07768694': 791, 'n02988304': 323, 'n12836862': 975, 'n07749446': 773, 'n04251144': 638, 'n07719213': 740, 'n01803078': 60, 'n12074408': 894, 'n04489817': 690, 'n01693334': 26, 'n03249569': 381, 'n04037443': 583, 'n13011595': 987, 'n01491361': 1, 'n11826198': 839, 'n11903671': 849, 'n03425413': 424, 'n12753007': 963, 'n12570394': 949, 'n02493793': 207, 'n02783161': 244, 'n02669723': 224, 'n01644373': 11, 'n02492660': 205, 'n02894605': 291, 'n04404412': 668, 'n07769584': 792, 'n03314780': 396, 'n01909906': 63, 'n02317335': 179, 'n02487347': 200, 'n02134084': 147, 'n02112497': 117, 'n03018712': 334, 'n04486054': 687, 'n07749969': 775, 'n03837869': 533, 'n03805725': 530, 'n01749939': 40, 'n02680754': 227, 'n03483823': 443, 'n04254680': 641, 'n02950826': 309, 'n12047884': 876, 'n11950345': 860, 'n01998183': 89, 'n03887697': 548, 'n11888800': 844, 'n03261776': 385, 'n04086273': 593, 'n11901294': 846, 'n02948072': 307, 'n03095699': 352, 'n02807133': 259, 'n03661043': 486, 'n04483307': 686, 'n02119789': 129, 'n03376595': 410, 'n02206856': 159, 'n04147183': 614, 'n03527444': 454, 'n03697007': 495, 'n04210120': 631, 'n02443484': 188, 'n03877472': 544, 'n11947802': 859, 'n02804610': 258, 'n11821184': 838, 'n02114548': 122, 'n12267677': 917, 'n11901597': 847, 'n03495258': 450, 'n02280649': 175, 'n12023726': 871, 'n04373894': 662, 'n03761084': 512, 'n02114712': 123, 'n03000134': 327, 'n03781787': 518, 'n04005630': 578, 'n01776313': 51, 'n02110341': 114, 'n03924679': 558, 'n02918964': 300, 'n03743016': 509, 'n07743544': 765, 'n03785016': 519, 'n13037406': 989, 'n03494278': 449, 'n13111881': 997, 'n03239726': 379, 'n02928608': 302, 'n11962272': 864, 'n13001930': 986, 'n02268443': 170, 'n02977058': 319, 'n01641577': 10, 'n12075010': 896, 'n07734744': 757, 'n03071160': 347, 'n01774750': 49, 'n03874599': 542, 'n03599486': 473, 'n02107142': 108, 'n01682714': 20, 'n12768682': 970, 'n04041544': 584, 'n02115641': 125, 'n12290748': 926, 'n03014705': 331, 'n04153751': 616, 'n01806567': 61, 'n07760859': 783, 'n02106662': 107, 'n12074867': 895, 'n07717556': 737, 'n02279972': 174, 'n12050533': 879, 'n03481172': 440, 'n02704792': 232, 'n01955084': 75, 'n13052670': 994, 'n04525305': 701, 'n12084890': 901, 'n04204238': 625, 'n04550184': 708, 'n04141975': 611, 'n03372029': 409, 'n12879527': 976, 'n01748264': 39, 'n03590841': 468, 'n04192698': 621, 'n12620546': 953, 'n03388549': 415, 'n12044467': 874, 'n03793489': 526, 'n11921395': 854, 'n02910353': 297, 'n02514041': 216, 'n02690373': 229, 'n02281787': 177, 'n03775071': 516, 'n07758680': 782, 'n03485794': 446, 'n03329302': 399, 'n03450230': 431, 'n03122295': 356, 'n02692877': 230, 'n02086079': 91, 'n12717072': 958, 'n04229816': 633, 'n01632777': 7,
'n12076223': 898, 'n03110669': 355, 'n01990800': 88, 'n11727540': 825, 'n02123159': 133, 'n03804744': 529, 'n04243546': 637, 'n04201297': 624, 'n03954731': 564, 'n02094433': 96, 'n04423845': 674, 'n07762913': 784, 'n07765208': 786, 'n11725821': 824, 'n03676483': 491, 'n11712282': 822, 'n02120505': 131, 'n09421951': 811, 'n03041632': 340, 'n01978455': 80, 'n03000247': 328, 'n01641206': 8, 'n12754003': 964, 'n12269241': 918, 'n03457902': 433, 'n04392985': 666, 'n02872752': 283, 'n02641379': 221, 'n03982232': 574, 'n03852688': 537, 'n12606438': 952, 'n02952374': 312, 'n02859443': 277, 'n02493509': 206, 'n01729322': 31, 'n11908846': 853, 'n03666591': 488, 'n01768244': 42, 'n11709205': 820, 'n03633091': 480, 'n02116738': 126, 'n03657121': 485, 'n03786901': 520, 'n11904109': 850, 'n03895866': 552, 'n01978287': 79, 'n03420801': 422, 'n03742115': 508, 'n12049282': 877, 'n01687978': 22, 'n03773504': 515, 'n12144580': 905, 'n07764155': 785, 'n12683407': 956, 'n02992529': 325,
'n03146219': 364, 'n03445777': 427, 'n03757604': 510, 'n02488702': 202, 'n02128925': 141, 'n02509815': 214, 'n03127747': 359, 'n07753592': 779, 'n02128385': 139, 'n04579432': 715, 'n04254777': 642, 'n02823428': 267, 'n02898711': 294, 'n09246464': 804, 'n03982430': 575, 'n03393912': 416, 'n12201580': 912, 'n04442312': 677, 'n04515003': 697, 'n03325584': 398, 'n03272562': 389, 'n03623198': 477, 'n02490219': 204, 'n03034663': 339, 'n02090827': 93, 'n12987056': 984, 'n03717622': 501,
'n04200800': 623, 'n01983481': 83, 'n04487081': 688, 'n03598930': 472, 'n03902125': 553, 'n01667778': 16, 'n07723039': 746, 'n02787622': 246, 'n02971356': 318, 'n02824448': 269, 'n12055516': 882, 'n13054560': 995, 'n01779629': 52, 'n02897820': 293, 'n03360622': 408, 'n12727518': 961, 'n02101006': 103, 'n09428293': 812, 'n02219486': 160, 'n03791053': 524, 'n04252225': 640, 'n12560282': 948, 'n03770679': 514, 'n03444034': 426, 'n02167151': 153, 'n03201208': 372, 'n04554684': 711, 'n03908204': 554, 'n02738535': 236, 'n04118776': 601, 'n01986214': 86,
'n04258138': 643, 'n03763968': 513, 'n12713866': 957, 'n11889619': 845, 'n03240683': 380, 'n01695060': 28, 'n12278650': 921, 'n03018349': 333, 'n12069679': 890, 'n02096294': 97, 'n12966945': 981, 'n12495895': 940, 'n12052787': 881, 'n07745940': 770, 'n02113712': 119, 'n02701002': 231, 'n03980874': 573, 'n12496427': 941, 'n11759404': 831, 'n04525584': 702, 'n01641391': 9, 'n02843684': 276, 'n03701391': 496, 'n03530642': 456, 'n11664418': 817, 'n02483708': 196, 'n04453156': 679, 'n07730406': 754, 'n12663023': 955, 'n02165456': 152, 'n02231487': 163, 'n03844815': 536, 'n01644900': 12, 'n02497673': 209, 'n03461385': 435, 'n04209239': 630, 'n03956157': 565, 'n12754981': 965, 'n02882647': 286, 'n03476684': 437, 'n03733805': 507, 'n02727426': 234, 'n04389033': 665, 'n03929855': 559, 'n03710721': 500, 'n07743902': 766, 'n03218198': 376, 'n02950632': 308, 'n01728572': 29, 'n04259630': 644, 'n07727048': 751, 'n13133613': 998, 'n04325704': 651, 'n11955896': 861, 'n02966193': 316, 'n12076577': 899,
'n11943660': 857, 'n12056217': 883, 'n12051103': 880, 'n02887489': 288, 'n03888257': 549, 'n02965783': 315, 'n03068998': 346, 'n02488291': 201, 'n02123597': 135, 'n02786058': 245, 'n04467665': 684, 'n04498389': 693, 'n12073991': 893, 'n12582231': 951, 'n03662601': 487, 'n03032252': 338, 'n04102406': 596, 'n03485407': 445, 'n04552348': 709, 'n07715103': 732, 'n02841315': 275, 'n02274822': 172,
'n04411264': 670, 'n04509417': 696, 'n12890265': 978, 'n04021028': 580, 'n03940256': 562, 'n07767171': 789, 'n01945685': 72, 'n02119022': 128, 'n04204347': 626, 'n03026506': 336, 'n12884260': 977, 'n01985128': 85, 'n11971248': 866, 'n03301568': 394, 'n12755225': 966, 'n03075370': 349, 'n03721384': 503, 'n07747607': 772,
'n03720891': 502, 'n07730033': 753, 'n12158031': 907, 'n03680355': 492, 'n04326547': 652, 'n12403994': 935, 'n04050066': 587, 'n04562935': 713, 'n04350905': 657, 'n02672831': 225, 'n12527738': 946, 'n04125021': 603, 'n07716358': 734, 'n03670208': 489, 'n12049562': 878, 'n13043926': 991, 'n12190410': 910, 'n02895154': 292, 'n04270147': 645, 'n02132136': 145, 'n02776631': 241, 'n04081281': 592, 'n03467068': 436, 'n07772147': 795, 'n02568087': 219, 'n03384352': 412, 'n07735803': 760, 'n03825788': 532, 'n03816136': 531, 'n12478768': 938, 'n04501370': 694, 'n07735510': 759, 'n02130308': 144, 'n01735189': 34, 'n04003241': 576, 'n12065316': 889, 'n02277742': 173, 'n04118538': 600, 'n12062468': 887, 'n02956795': 313, 'n02108551': 110, 'n04491638': 691, 'n12083591': 900, 'n02123394': 134, 'n04140064': 608, 'n11759853': 832, 'n12266796': 916, 'n04576002': 714, 'n11805956': 835, 'n12284262': 925,
'n04381587': 664, 'n04517823': 698, 'n02108089': 109, 'n02100877': 102, 'n03445924': 428, 'n02963159': 314, 'n11695974': 818, 'n03857828': 539, 'n11810358': 837, 'n02510455': 215, 'n04371430': 660, 'n02168699': 154, 'n04553703': 710, 'n02268853': 171, 'n03788195': 522, 'n12833149': 973, 'n02190166': 157, 'n01774384': 48, 'n02817516': 266, 'n09344324': 809, 'n12199790': 911, 'n03482405': 441, 'n03291819': 392, 'n11978233': 868, 'n04347754': 655, 'n12658118': 954, 'n07774719': 799, 'n02114855': 124, 'n03492922': 448, 'n04004767': 577, 'n02110806': 115, 'n13044778': 992, 'n03690938': 493, 'n02109961': 113, 'n03868863': 541, 'n04355338': 658, 'n04310018': 649, 'n03884397': 546, 'n04143140': 612, 'n02814533': 263, 'n04275548': 647, 'n02825657': 270, 'n03797390': 528, 'n11756669': 829, 'n02877765': 284, 'n01664065': 13, 'n02764044': 238, 'n04332074': 653, 'n07717410': 736, 'n04376876': 663, 'n02865351': 279, 'n07736692': 761, 'n03355925': 405, 'n07739344': 763, 'n11907100': 852, 'n04409515': 669, 'n04523525': 700, 'n03909406': 556, 'n02109525': 112, 'n12202936': 913,
'n01629819': 5, 'n06595351': 724, 'n09332890': 808, 'n02321529': 181, 'n03180011': 368, 'n03131574': 361, 'n03250847': 382, 'n03255030': 383, 'n02262449': 168, 'n03404251': 419, 'n04162706': 618, 'n01734418': 33, 'n13040303': 990, 'n02769748': 239, 'n03594734': 469, 'n02808304': 261, 'n02480495': 192, 'n03109150': 354, 'n04435653': 676, 'n04141327': 610, 'n02259212': 167, 'n01729977': 32, 'n12293723': 927, 'n13136316': 999, 'n04295881': 648, 'n03476991': 438, 'n04522168': 699, 'n02951585': 311, 'n03358172': 406, 'n12281788': 922, 'n04398044': 667, 'n12401684': 934, 'n03063689': 344, 'n03788365': 523, 'n03604400': 475, 'n03543254': 460, 'n03973628': 568, 'n02101388': 104, 'n09270735': 806, 'n03709823': 497, 'n02325366': 182, 'n03496892': 451, 'n02917067': 299, 'n04127521': 604, 'n11969607': 865, 'n07718747': 739, 'n03297495': 393, 'n12513933': 944, 'n11980318': 869, 'n03320519': 397, 'n01742172': 38, 'n12985857': 983, 'n01784675': 53, 'n07721678': 744, 'n04589890': 717, 'n02791124': 249, 'n03545756': 462, 'n04235860': 635, 'n11757851': 830, 'n11958080': 862, 'n04464615': 682, 'n12281974': 923, 'n04465501': 683, 'n02909870': 296,
'n12085267': 902, 'n02085620': 90, 'n01981276': 82, 'n11736694': 827, 'n02129165': 142, 'n03345487': 402, 'n02129604': 143, 'n01685808': 21, 'n12302071': 929, 'n03452741': 432, 'n03075097': 348, 'n04346328': 654, 'n09288635': 807, 'n02788148': 247, 'n02447366': 191, 'n12360108': 933, 'n04542943': 706, 'n03150511': 365, 'n04208210': 628, 'n03266371': 386, 'n03908714': 555, 'n03424325': 423, 'n01494475': 2, 'n12070016': 891, 'n07723559': 748, 'n02236044': 165, 'n01675722': 18, 'n02797295': 254, 'n01980166': 81, 'n11939491': 856, 'n04443257': 678, 'n02445715': 190, 'n03351979': 404, 'n02113799': 120, 'n03124170': 357, 'n01963571': 77, 'n02814860': 264,
'n12301445': 928, 'n02106382': 106, 'n11859737': 841, 'n02229544': 162, 'n02708093': 233, 'n03877674': 545, 'n03359436': 407, 'n01930112': 68, 'n03930630': 561, 'n01688243': 23, 'n04148054': 615, 'n02124075': 136, 'n03642806': 483, 'n04540053': 705, 'n02106166': 105, 'n02489166': 203, 'n12043836': 873, 'n03673027': 490, 'n02125311': 137, 'n04536866': 704, 'n11721337': 823, 'n04584207': 716, 'n12741792': 962, 'n02773838': 240, 'n03854815': 538, 'n02092002': 94, 'n04065272': 588, 'n12946849': 980, 'n12276872': 920, 'n12059625': 886, 'n03970156': 567, 'n01692333': 25, 'n03207743': 373, 'n07772788': 797, 'n02508021': 213, 'n07772935': 798, 'n13049953': 993, 'n01773797': 47, 'n02444819': 189, 'n07711080': 726, 'n02484975': 197, 'n03886762': 547,
'n02137549': 149, 'n02443114': 187, 'n03868242': 540, 'n02120079': 130, 'n03223299': 378, 'n04532106': 703, 'n04146614': 613, 'n01798484': 59, 'n07734292': 756, 'n07765361': 787, 'n07767549': 790, 'n04252077': 639, 'n03967562': 566, 'n02966687': 317, 'n04141076': 609, 'n04507155': 695, 'n07757132': 781, 'n07721195': 743, 'n02100583': 100, 'n03478589': 439, 'n01935395': 69, 'n02906734': 295, 'n12570972': 950, 'n03134739': 362, 'n02860847': 278, 'n11770256': 833, 'n02804414': 257,
'n03309356': 395, 'n04179913': 619, 'n01498041': 4, 'n01630670': 6, 'n01773549': 46, 'n03273740': 390, 'n07753113': 777, 'n01953361': 74, 'n03259280': 384, 'n04070727': 590, 'n03085013': 350, 'n04194127': 622, 'n02942349': 306, 'n02730930': 235, 'n12172364': 908, 'n12242409': 914, 'n03571625': 465, 'n02815834': 265, 'n12756457': 968, 'n04220250': 632, 'n12830222': 972, 'n04458633': 680, 'n04548362': 707, 'n01910747': 64, 'n02114367': 121,
'n03594945': 470, 'n03337140': 400, 'n11879895': 842, 'n04349306': 656, 'n04417672': 671, 'n03974915': 569, 'n03691459': 494, 'n01944390': 71, 'n03792782': 525, 'n04120489': 602, 'n07744246': 767, 'n12023407': 870, 'n03787032': 521, 'n03920867': 557, 'n02177972': 156, 'n07729485': 752, 'n07775050': 800, 'n03602883': 474, 'n02791270': 250, 'n12345899': 932, 'n03838899': 534, 'n07735404': 758, 'n02481823': 194, 'n07775197': 801, 'n03447721': 430, 'n09472597': 814, 'n12282737': 924, 'n04102037': 595, 'n12496949': 942, 'n11709674': 821,
'n07716906': 735, 'n02281406': 176, 'n03876231': 543, 'n12317296': 931, 'n04069434': 589, 'n04418357': 672, 'n01914609': 65, 'n03636649': 481, 'n01986806': 87, 'n02442845': 186, 'n04111531': 597, 'n03557692': 463, 'n07754684': 780, 'n02100735': 101, 'n02807616': 260, 'n03400231': 418, 'n03028079': 337, 'n07713763': 728, 'n02777292': 242, 'n02979186': 320, 'n04116512': 598, 'n12765115': 969, 'n06359193': 723, 'n07745466': 769, 'n03584829': 467, 'n01795545': 56, 'n01787835': 55, 'n02319095': 180, 'n03841143': 535, 'n11923397': 855, 'n03047690': 342, 'n02892201': 289, 'n01775062': 50,
'n03100240': 353, 'n03544143': 461, 'n03141823': 363, 'n12985420': 982, 'n02099267': 98, 'n03505504': 452, 'n11636835': 816, 'n07714448': 729, 'n03417042': 421, 'n02951358': 310, 'n04233124': 634, 'n01753488': 41, 'n01667114': 15, 'n12064389': 888, 'n04133789': 606, 'n02133161': 146, 'n04496726': 692, 'n02929289': 303, 'n01950731': 73, 'n02123045': 132, 'n01984695': 84, 'n07711569': 727,
'n03595614': 471, 'n03617480': 476, 'n04367480': 659, 'n04049303': 586, 'n04373704': 661, 'n12998815': 985, 'n01689811': 24, 'n01915811': 66, 'n02840245': 274, 'n04317175': 650, 'n11971783': 867, 'n11748811': 828, 'n12304703': 930, 'n04185804': 620, 'n02793495': 251, 'n03416489': 420, 'n02640242': 220, 'n02537525': 218, 'n02808440': 262, 'n02165105': 151, 'n02823750': 268,
'n02138441': 150, 'n03630383': 479, 'n02093256': 95, 'n11960245': 863, 'n02226429': 161, 'n03759954': 511, 'n03891251': 551, 'n02504013': 211, 'n02441942': 185, 'n03220513': 377, 'n12833985': 974, 'n03065424': 345, 'n02099601': 99, 'n02930766': 304, 'n07715221': 733, 'n12407079': 936, 'n03521675': 453, 'n02200198': 158, 'n02747177': 237, 'n02127052': 138, 'n03000684': 329, 'n01665541': 14,
'n02869837': 280, 'n04273569': 646, 'n02494079': 208, 'n03347037': 403, 'n03187595': 369, 'n07766173': 788, 'n03976467': 570, 'n02790996': 248, 'n04428191': 675, 'n03733281': 506, 'n12774299': 971, 'n02992211': 324, 'n02134418': 148, 'n02500267': 210, 'n02939185': 305, 'n12189987': 909, 'n11887119': 843, 'n03160309': 366, 'n12086012': 903, 'n02981792': 322, 'n04009552': 579, 'n07746186': 771, 'n03977966': 571,
'n07737745': 762, 'n03584254': 466, 'n01956481': 76, 'n04421872': 673, 'n01737021': 35, 'n02486410': 199, 'n04596742': 720, 'n02111277': 116, 'n12916511': 979, 'n02794156': 252, 'n01669191': 17, 'n02927161': 301, 'n03492542': 447, 'n12154773': 906, 'n04555897': 712, 'n02834397': 271}


def main(n_files=1261405):

    numpy.random.seed(0xbeef)
    data = h5py.File("imagenet_256x256_train.h5", "w")

    excluded_targets = load_excluded_targets()

    data.create_dataset("x", (n_files, 256*256*3), 'uint8')
    data.create_dataset("y", (n_files,), 'uint32')

    inds = range(n_files)
    numpy.random.shuffle(inds)

    i = 0
    target = 0
    for directory, dirnames, filenames in os.walk("train/"):
        if len(filenames) == 0:
            n_dirs = len(dirnames)
            continue

        begin = time.time()
        for filename in filenames:
            path = os.path.join(directory, filename)
            im = Image.open(path).convert('L')
            im.thumbnail((256 if im.size[0] < im.size[1] else im.size[0], 256 if im.size[0] > im.size[1] else im.size[1]))
            if im.size[0] != 256:
                excess = (im.size[0] - 256) / 2
                im = im.crop((excess, 0, 256+excess, 256))
            elif im.size[1] != 256:
                excess = (im.size[1] - 256) / 2
                im = im.crop((0, excess, 256, 256+excess))

            data['x'][inds[i]] = numpy.asarray(im.getdata(), "uint8").T.flatten()
            data['y'][inds[i]] = TARGETS[directory[len("train/"):]]

            i += 1
        end = time.time()

        print "%d/%d %s (%.2fs)" % (target, n_dirs, directory, end-begin)
        target += 1


if __name__ == "__main__":
    excluded_targets = load_excluded_targets()
    import ipdb; ipdb.set_trace()
    #main()
